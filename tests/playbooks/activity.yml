---
- name: Simulate activity
  hosts: all
  any_errors_fatal: true
  tasks:
    - name: Copy script to remote host
      copy:
        src: scripts/simulate-activity-basic.bash
        dest: /tmp/simulate-activity-basic.bash
        mode: '0755'
      when: >
        'primary' in group_names and
        (hostvars[inventory_hostname].pgbackrest is defined and hostvars[inventory_hostname].pgbackrest == true)

    - name: Simulate basic activity
      command: /usr/bin/env bash /tmp/simulate-activity-basic.bash -s 10 -a 10 2>&1 |tee /var/log/simulate-activity-basic.log
      environment:
        PGBIN: "{{ cluster_vars['pg_bin_path'] }}"
        PGDATABASE: "{{ cluster_vars['pg_database'] }}"
        PGSVC: "{{ cluster_vars['pg_service'] }}"
        PGUNIXSOCKET: "{{ cluster_vars['pg_unix_socket'] }}"
        PGUSER: "{{ cluster_vars['pg_owner'] }}"
        STANZA: "{{ cluster_vars['cluster_name'] }}"
        PGBR_HOST: "{{ cluster_vars['pgbackrest_repo_host'] | default(None) }}"
        PGBR_STANDBIES: "{{ cluster_vars['pgbackrest_standbies'] | default(None) }}"
        PGBR_USER: "{{ cluster_vars['pgbackrest_user'] }}"
        SCRIPT_PROFILE: ""
      vars:
        cluster_vars: "{{ ansible_local['profile']['global'] }}"
      register: basic_activity_output
      when: >
        'primary' in group_names and
        (hostvars[inventory_hostname].pgbackrest is defined and hostvars[inventory_hostname].pgbackrest == true)

    - name: Basic activity output
      debug: var=basic_activity_output.stdout_lines
      when: basic_activity_output.changed